# Senior Dev Review — Uncommitted Changes (2026-02-24)

## Executive Summary

All changes are **production-ready** and form coherent feature sets. Type-check passes (`pnpm exec tsc --noEmit`). Recommended commit order: docs → deps → migrations → settings → auth/perspective → news → ESPN → agents → chat UI → types.

---

## Change Categories & Stability Assessment

| Category | Files | Risk | Notes |
|----------|-------|------|-------|
| Docs & config | README, GETTING_STARTED, docs/*, CHANGELOG | Low | Safe; no runtime impact |
| Dependencies | package.json, pnpm-lock | Low | LangGraph, react-hook-form, sonner, Radix UI |
| DB migrations | 3 SQL files | Medium | Run in sequence; back up before deploy |
| Settings | schema, lib, actions, components, page | Low | Tested; INSERT policy fix included |
| Auth & perspective | perspective-context, perspective-authorization | Medium | Critical path; user_settings fallback |
| News | news.service, news-preferences, ops/news-stats | Low | ESPN full-content fetch, source prefs |
| ESPN & game logs | espn/client, game-log.service | Low | New getPlayerGameLog; cache-on-read |
| League service | league.service | Medium | **Important**: Cache key now includes leagueId/teamId/seasonId (prevents cross-user data) |
| Agents | LangGraph supervisor + player-research | Medium | New feature; audit findings addressed |
| Chat UI | chat-interface, sidebar, history-context | Low | Agent mode toggle; Toaster |
| Types | supabase.ts, golden_dataset.json | Low | Regenerated; eval fixtures |

---

## Critical Findings

### ✅ Security / Correctness

1. **League cache key** (`league.service.ts`): `unstable_cache` previously used a static key `['league-service-fetch-matchup']`. Now includes `leagueId`, `teamId`, `seasonId` — **prevents one user’s roster being served to another**. Good fix.
2. **Perspective auth** (`perspective-authorization.ts`): Authenticated users no longer fall back to env default when no team requested; uses `user_leagues` or `user_settings` instead.

### ⚠️ Defer / Follow-up

1. **`gemini_api_key_encrypted`**: Still stored as plain text; doc notes "swap for Supabase Vault / pgcrypto as needed".
2. **Ollama tool forcing**: With `USE_LOCAL_AI=true`, agent does not force `tool_choice`; audit recommends using Gemini for audits until classifier improves.

---

## Recommended Commit Order

| # | Group | Message |
|---|-------|---------|
| 1 | CHANGELOG + docs | `chore: add CHANGELOG and update docs (Ollama model, agent arch, settings)` |
| 2 | Dependencies | `build: add LangGraph, react-hook-form, sonner, news:stats script` |
| 3 | DB migrations | `feat(db): player_game_logs, user_settings ESPN fields, news full_content & sources` |
| 4 | Settings | `feat(settings): user settings page, ESPN IDs, news source prefs, UI primitives` |
| 5 | Auth & perspective | `fix(auth): perspective from user_settings, no env fallback for authed users` |
| 6 | News | `feat(news): full ESPN article fetch, news_sources, user_news_preferences` |
| 7 | ESPN & game logs | `feat(espn): getPlayerGameLog, game-log.service, player_game_logs cache` |
| 8 | League service | `fix(league): cache key includes league/team/season, fetchLeagueForTool for agents` |
| 9 | Agents | `feat(agents): LangGraph supervisor, player-research agent, /api/agent/chat` |
| 10 | Chat UI | `feat(chat): agent/classic mode toggle, Toaster, mode in conversation` |
| 11 | Types & eval | `chore: regenerate supabase types, extend golden_dataset` |

---

## Files to Commit

### Group 1 — CHANGELOG + docs
- `CHANGELOG.md` (new)
- `GETTING_STARTED.md`
- `README.md`
- `docs/README.md`
- `docs/genesis/FanVise PRD_ AI Fantasy Sports Strategy.md`
- `docs/technical/API_and_Agents.md`
- `docs/technical/Architecture.md`
- `docs/technical/Database.md`
- `docs/technical/Lineup_Optimization_Flow.md`
- `docs/technical/Models_and_Environments.md`
- `docs/technical/System_Prompts.md`
- `docs/settings-setup.md` (new)
- `docs/technical/Agentic_Architecture_LangGraph.md` (new)
- `docs/technical/Player_News_Live_Fetch.md` (new)
- `docs/technical/Player_Research_Agent.md` (new)
- `docs/audits/AGENT_TEST_FINDINGS_2026-02-23.md` (new)
- `docs/audits/INCIDENT_2026-02-23_Roster_FreeAgent_Confusion.md` (new)

### Group 2 — Dependencies
- `package.json`
- `pnpm-lock.yaml`

### Group 3 — Migrations
- `supabase/migrations/20260223000000_player_game_logs.sql`
- `supabase/migrations/20260223100000_add_espn_fields_to_user_settings.sql`
- `supabase/migrations/20260223200000_news_full_content_and_sources.sql`

### Group 4 — Settings
- `src/lib/settings-schema.ts`
- `src/lib/settings.ts`
- `src/actions/settings.ts`
- `src/actions/news-preferences.ts`
- `src/components/settings/settings-form.tsx`
- `src/components/settings/news-sources-section.tsx`
- `src/components/ui/form.tsx`
- `src/components/ui/label.tsx`
- `src/components/ui/separator.tsx`
- `src/components/ui/switch.tsx`
- `src/app/settings/page.tsx`

### Group 5 — Auth & perspective
- `src/lib/perspective-context.tsx`
- `src/utils/auth/perspective-authorization.ts`

### Group 6 — News
- `src/services/news.service.ts`
- `src/services/news-preferences.service.ts`
- `src/ops/news-stats.ts`

### Group 7 — ESPN & game logs
- `src/lib/espn/client.ts`
- `src/services/game-log.service.ts`

### Group 8 — League
- `src/services/league.service.ts`

### Group 9 — Agents
- `src/agents/**`
- `src/app/api/agent/**`
- `prompts/agents/orchestrator.ts`
- `prompts/index.ts`

### Group 10 — Chat UI
- `src/app/layout.tsx`
- `src/components/chat/chat-interface.tsx`
- `src/components/chat/chat-history-context.tsx`
- `src/components/chat/sidebar.tsx`
- `src/app/api/chat/route.ts`
- `src/services/ai.service.ts`

### Group 11 — Types & eval
- `src/types/supabase.ts`
- `fanvise_eval/golden_dataset.json`
